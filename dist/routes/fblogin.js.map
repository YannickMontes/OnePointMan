{"version":3,"sources":["../../routes/fblogin.js"],"names":["axios","require","express","router","Router","querystring","facebookdata","db","squelb","sender","squel","useFlavour","_sendResponse","status","message","res","send","_getUserAccessToken","str","requestToken","redirectURI","client_id","redirect_uri","client_secret","code","get","_getAppAccessToken","apiAppRequest","requestAPI","grant_type","_inspectUserToken","inspectTokenRequest","input_token","userAccessToken","access_token","appAccessToken","_checkIfUserExists","user_id","query","select","from","where","toString","_insertNewUser","userlastname","userfirstname","insert","into","set","_getUserDataFromFb","userData","uri","_bindLoggedUserData","responseFromfb","loggedUser","prenom","first_name","nom","last_name","photo","picture","iduser","userFbId","_updateDataAfterAuth","update","table","req","next","console","log","facebookURI","scope","SUCCESS_STATUS","parse","originalUrl","substring","indexOf","length","then","response","data","catch","error","existingUser","post","body","token","userId","BAD_REQUEST","e","module","exports"],"mappings":"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","file":"fblogin.js","sourcesContent":["const axios = require('axios');\r\nconst express = require('express');\r\nconst router = express.Router();\r\nconst querystring = require('querystring');\r\nconst facebookdata = require(\"../facebookdata\");\r\n\r\nconst db = require('../connection');\r\nconst squelb = require('squel');\r\nconst sender = require(\"../sender\");\r\nconst squel = squelb.useFlavour('postgres');\r\n\r\nconst _sendResponse = (status, message, res) => {\r\n    res.status(status);\r\n    res.send(message);\r\n};\r\n\r\nconst _getUserAccessToken = (str) => {\r\n    let requestToken = {\r\n        redirectURI: 'https://graph.facebook.com/v2.11/oauth/access_token?',\r\n        client_id: '137357800216709',\r\n        redirect_uri: 'http://localhost:3000/handleauth',\r\n        client_secret: '8120bf1c2ce2729a20d024a8c491c9b5',\r\n        code: str.code\r\n    };\r\n\r\n    return axios.get(requestToken.redirectURI + 'client_id=' + requestToken.client_id + '&redirect_uri=' + requestToken.redirect_uri\r\n        + '&client_secret=' + requestToken.client_secret + '&code=' + requestToken.code)\r\n};\r\n\r\nconst _getAppAccessToken = () => {\r\n\r\n    const apiAppRequest = {\r\n        requestAPI: 'https://graph.facebook.com/oauth/access_token?',\r\n        client_id: '137357800216709',\r\n        client_secret: '8120bf1c2ce2729a20d024a8c491c9b5',\r\n        grant_type: 'client_credentials'\r\n    };\r\n\r\n    return axios.get(apiAppRequest.requestAPI + 'client_id=' + apiAppRequest.client_id + '&client_secret='\r\n        + apiAppRequest.client_secret + '&grant_type=' + apiAppRequest.grant_type)\r\n};\r\n\r\nconst _inspectUserToken = () => {\r\n    let inspectTokenRequest = {\r\n        redirectURI: 'https://graph.facebook.com/debug_token?',\r\n        input_token: facebookdata.userAccessToken,\r\n        access_token: facebookdata.appAccessToken\r\n    };\r\n\r\n    return axios.get(inspectTokenRequest.redirectURI + 'input_token=' + inspectTokenRequest.input_token + '&access_token=' + inspectTokenRequest.access_token)\r\n};\r\n\r\nconst _checkIfUserExists = (user_id) => {\r\n    return db.query(squel\r\n        .select()\r\n        .from('\"USER\"')\r\n        .where('iduser = ?', user_id)\r\n        .toString())\r\n};\r\n\r\nconst _insertNewUser = (user_id, userlastname, userfirstname) => {\r\n    return db.query(squel\r\n        .insert()\r\n        .into('\"USER\"')\r\n        .set('iduser', user_id)\r\n        .set('nom', userlastname)\r\n        .set('prenom', userfirstname)\r\n        .toString())\r\n};\r\n\r\nconst _getUserDataFromFb = (user_id) => {\r\n    let userData = {\r\n        uri: 'https://graph.facebook.com/v2.11/',\r\n        user_id: user_id,\r\n        access_token: facebookdata.userAccessToken\r\n    };\r\n\r\n    return axios.get(userData.uri + userData.user_id + '?access_token=' + userData.access_token + '&fields=id,last_name,first_name,gender,picture');\r\n};\r\n\r\nconst _bindLoggedUserData = (responseFromfb) => {\r\n    loggedUser.prenom = responseFromfb.first_name;\r\n    loggedUser.nom = responseFromfb.last_name;\r\n    loggedUser.photo = responseFromfb.picture;\r\n    loggedUser.iduser = facebookdata.userFbId\r\n};\r\n\r\nconst _updateDataAfterAuth = (user_id) => {\r\n    //TODO: set is logged = true\r\n    return db.query(squel\r\n        .update()\r\n        .table('\"USER\"')\r\n        .set('lastconnexion', 'now()')\r\n        .where('iduser = ?', user_id)\r\n        .toString())\r\n};\r\n\r\nlet loggedUser = {\r\n    nom: '',\r\n    prenom: '',\r\n    iduser: '',\r\n    photo: ''\r\n};\r\n\r\nrouter.get('/', function (req, res, next) {\r\n    console.log(\"GET /fblogin\");\r\n\r\n    let facebookURI = {\r\n        redirectURI: 'https://www.facebook.com/v2.11/dialog/oauth?',\r\n        client_id: '137357800216709',\r\n        redirect_uri: 'http://localhost:3000/handleauth',\r\n        scope: 'email,user_friends'\r\n    };\r\n\r\n    _sendResponse(sender.SUCCESS_STATUS, facebookURI, res)\r\n\r\n    console.log(\"end GET /fblogin\");\r\n});\r\n\r\nrouter.get('/handleauth', function (req, res, next) {\r\n    console.log(\"GET /fblogin/handleauth\");\r\n\r\n    let str = querystring.parse(req.originalUrl.substring(req.originalUrl.indexOf(\"?\") + 1, req.originalUrl.length));\r\n\r\n    console.log('STR VALUE :' + str.code);\r\n\r\n    _getUserAccessToken(str)\r\n        .then(response => {\r\n\r\n            facebookdata.userAccessToken = response.data.access_token;\r\n\r\n            _getAppAccessToken()\r\n                .then(response => {\r\n\r\n                    facebookdata.appAccessToken = response.data.access_token;\r\n\r\n                    _inspectUserToken()\r\n                        .then(response => {\r\n                            facebookdata.userFbId = response.data.data.user_id;\r\n\r\n                            _getUserDataFromFb(facebookdata.userFbId)\r\n                                .then(response => {\r\n                                    _bindLoggedUserData(response.data);\r\n                                })\r\n                                .catch(error => {\r\n                                    console.log(error);\r\n                                });\r\n\r\n                            _checkIfUserExists(facebookdata.userFbId)\r\n                                .then(existingUser => {\r\n\r\n                                    if (existingUser.length === 0) {\r\n                                        console.log('User does not exist. Creating user with facebook ID : ' + facebookdata.userFbId);\r\n\r\n                                        _insertNewUser(facebookdata.userFbId, loggedUser.nom, loggedUser.prenom);\r\n                                    } else {\r\n                                        console.log('User with ID : ' + facebookdata.userFbId + 'already exists in database');\r\n                                    }\r\n\r\n                                    _updateDataAfterAuth(facebookdata.userFbId)\r\n                                        .then(() => {})\r\n                                        .catch(error => {\r\n                                            console.log(error);\r\n                                        });\r\n                                    ;\r\n\r\n                                    _sendResponse(sender.SUCCESS_STATUS, loggedUser, res);\r\n                                })\r\n                                .catch(error => {\r\n                                    console.log(error);\r\n                                });\r\n                        })\r\n                        .catch(error => {\r\n                            console.log(error);\r\n                        });\r\n                })\r\n                .catch(error => {\r\n                    console.log(error)\r\n                });\r\n        })\r\n        .catch(error => {\r\n            console.log(error)\r\n        });\r\n\r\n    console.log(\"end GET /fblogin/handleauth\");\r\n});\r\n\r\nrouter.post('/authAndroid', function (req, res) {\r\n\r\n    facebookdata.userAccessToken = req.body.token;\r\n    facebookdata.userFbId = req.body.userId;\r\n\r\n    _getAppAccessToken()\r\n        .then(response => {\r\n\r\n            facebookdata.appAccessToken = response.data.access_token;\r\n\r\n            _getUserDataFromFb(facebookdata.userFbId)\r\n                .then(response => {\r\n                    _bindLoggedUserData(response.data);\r\n\r\n                    _checkIfUserExists(facebookdata.userFbId)\r\n                        .then(existingUser => {\r\n\r\n                            if (existingUser.length === 0) {\r\n                                console.log('User does not exist. Creating user with facebook ID : ' + facebookdata.userFbId);\r\n\r\n                                _insertNewUser(facebookdata.userFbId, loggedUser.nom, loggedUser.prenom);\r\n\r\n                                _sendResponse(sender.SUCCESS_STATUS, loggedUser, res);\r\n                            } else {\r\n                                console.log('User with ID : ' + facebookdata.userFbId + 'already exists in database');\r\n\r\n                                _sendResponse(sender.SUCCESS_STATUS, loggedUser, res);\r\n                            }\r\n                        })\r\n                        .catch(error => {\r\n                            console.log(error);\r\n\r\n                            _sendResponse(sender.BAD_REQUEST, 'error while getting existing user', res);\r\n                        });\r\n                })\r\n                .catch(error => {\r\n                    console.log(error);\r\n\r\n                    _sendResponse(sender.BAD_REQUEST, 'error while binding user data', res);\r\n                });\r\n        })\r\n        .catch(e => {\r\n            console.log('Android auth error ' + e);\r\n\r\n            _sendResponse(sender.BAD_REQUEST, 'error while getting app token', res);\r\n        })\r\n});\r\n\r\nmodule.exports = router;"]}